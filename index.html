<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <title>GoRobo + Swears</title> 
  <script src="jquery.min.js"></script> 
</head> 
<body>
    
  <script type="text/javascript" charset="utf-8"> 
      
    // TODO: encapsulate this in a thingie
    
    SWEARS = {
      setIntervalId: 0,
      target: false,
      width: false,
      height: false,
      composite: false,
      layer_buffer: {},
      layers: [],
      
      add_layer: function() {
        layer = function() {
          this.x = 0;
          this.y = 0;
          this.data = Array(Array(false));
          this.key = SWEARS.layers.length;
        }
        
        var new_layer = new layer();
        SWEARS.layers.push(new_layer);
        SWEARS.layer_buffer[SWEARS.layers.length - 1] = SWEARS.layers.length - 1; // THINK: this might not work if we've deleted layers
        return new_layer;
      },
      
      remove_layer: function(layer) {
        // TODO: make this
      },
      
      layer_move_up: function(layer) {
        var index = SWEARS.layer_buffer[layer.key];
        if(index == SWEARS.layers.length - 1) {return false;}
        var next = SWEARS.layers[index + 1];
        SWEARS.layers[index] = next;
        SWEARS.layers[index + 1] = layer;
        SWEARS.layer_buffer[layer.key]++;
        SWEARS.layer_buffer[next.key]--;
      },
      
      layer_move_down: function(layer) {
        var index = SWEARS.layer_buffer[layer.key];
        if(index == 0) {return false;}
        var prev = SWEARS.layers[index - 1];
        SWEARS.layers[index] = prev;
        SWEARS.layers[index - 1] = layer;
        SWEARS.layer_buffer[layer.key]--;
        SWEARS.layer_buffer[prev.key]++;
      },
      
      // use a renderer to display stuff
      // TODO: allow renderer choice
      render: function() {
        SWEARS.renderers.pre();
      },
      
      // start the sequence
      play: function(framerate, target, width, height, callback) {
        SWEARS.target = target;
        SWEARS.width = width;
        SWEARS.height = height;
        
        if(!parseInt(framerate)) {return false;}
        var micros = parseInt(1000 / parseInt(framerate));
        micros = micros < 10 ? 10 : micros;
        SWEARS.setIntervalId = setInterval(function() {
          callback();
          SWEARS.render();
        }, micros);
      },
      
      // freeze time
      pause: function() {
        clearInterval(SWEARS.setIntervalId);
        delete(SWEARS.setIntervalId);
      },
      
      // TODO: move these outside and make it extensible
      renderers: {
        pre: function() {
          // pre-initialize composite array
          var composite = [];
          for(var y = 0; y < SWEARS.height; y++) {
            composite[y] = [];
            for(var x = 0; x < SWEARS.width; x++) {
              composite[y][x] = false;
            }
          }
          
          // composite layers
          for(var i = 0; i < SWEARS.layers.length; i++) {
            for(var y = SWEARS.layers[i].data.length - 1; y >= 0; y--) {
              for(var x = SWEARS.layers[i].data[y].length - 1; x >= 0; x--) {
                if(SWEARS.layers[i].data[y][x] !== false) {
                  if(SWEARS.layers[i].invisible) {continue;}
                  var true_y = y + SWEARS.layers[i].y;
                  var true_x = x + SWEARS.layers[i].x;
                  if(true_x < 0 || true_x >= SWEARS.width || true_y < 0 || true_y >= SWEARS.height) {continue;}
                  composite[true_y][true_x] = SWEARS.layers[i].data[y][x];
                }
              }
            }
          }
          
          // composite -> string
          var string = '';
          for(var y = 0; y < SWEARS.height; y++) {
            for(var x = 0; x < SWEARS.width; x++) {
              string += composite[y][x] !== false ? composite[y][x] : ' ';
            }
            string += "\n";
          }
          
          // render in target
          SWEARS.target.innerHTML = string;
        }
      },
      
      // utility function for changing strings in matrices
      make_matrix: function(string) {
        var matrix = [];
        var lines = string.split(/\n/);
        for(var i=0; i < lines.length; i++) {
          var chars = [];
          for(var j=0; j < lines[i].length; j++) {
            chars.push(lines[i][j]);
          }
          matrix.push(chars);
        }
        
        return matrix;
      }
      
    };
    
    
    
    // game specific stuff
    
    
    
    // callback thing
    call_me = function() {
      if(SWEARS.index >= SWEARS.moves.length - 1) {
        $('#winner span.winner_name').text(file.winner.name);
        $('#winner').show();
        SWEARS.pause();
      }
      
      // cycle through the move list
      var move = SWEARS.moves[SWEARS.index];
      SWEARS.index++;
      
      // have we seen this thing?
      if(!SWEARS.things[move.id]) {
        // build thing
        SWEARS.things[move.id] = {};
        SWEARS.things[move.id].name = move.name || 'unnamed';
        SWEARS.things[move.id].layer = SWEARS.add_layer();
        if(move.robo_type == 'Speedy') { // tank
          var charx = move.name.slice(0,1);
        } else if(move.robo_type == 'Wall') { // wall
          var charx = 'X';          
        } else if(move.robo_type == 'Rocket') { // rocket
          var charx = '*';          
        }
        
        SWEARS.things[move.id].layer.data = [[charx]];
      }
      
      // kill the thing?
      if(move.health <= 0) {
        // TODO: make this better
        SWEARS.things[move.id].layer.invisible = true;

        // remove the layer
        delete(SWEARS.things[move.id].layer); 
        
        // remove the thing
        delete(SWEARS.things[move.id]);
        
        // TODO: refactor me!
        var div = $('#health');
        if(!$('#' + move.id).length > 0 && move.name != null) {
          div.append($('<p id="' + move.id + '"><span class="name">' + move.name + '</span>: <span class="health">' + move.health + '</span></p>'));
        }
        var p = $('#' + move.id);
        $('.health', p).text('DEAD');
        
        return false;
      }
      
      // check coords
      var new_x = move.x;
      var new_y = move.y;
      if(new_y <= 0) {new_y = 0;}
      if(new_y >= SWEARS.height - 2) {new_y = SWEARS.height - 2} // one for the layer width, one for the zero-offset
      if(new_x <= 0) {new_x = 0;}
      if(new_x >= SWEARS.width - 2) {new_x = SWEARS.width - 2} // one for the layer width, one for the zero-offset
      
      // move the thing
      SWEARS.things[move.id].layer.x = new_x;
      SWEARS.things[move.id].layer.y = new_y;
      
      // update the thing
      SWEARS.things[move.id].health = move.health;
      
      // display health
      var div = $('#health');
      if(!$('#' + move.id).length > 0 && move.name != null) {
        div.append($('<p id="' + move.id + '"><span class="name">' + move.name + '</span>: <span class="health">' + move.health + '</span></p>'));
      }
      var p = $('#' + move.id);
      $('.health', p).text(move.health);
      
    }
        
    // hook for anchor
    do_stuff = function() {
      if(typeof file != 'undefined') {
        SWEARS.play(SWEARS.framerate, document.getElementById('target'), file.world_width, file.world_height, call_me);
        return false;
      }
      
      // get array from the server (json file)
      $.getJSON('robo.json', function(json) {
        file = json;
        
        // put in background layer
        var background = SWEARS.add_layer();
        background.data = SWEARS.make_matrix(file.background);

        // get width and height
        var width = file.world_width;
        var height = file.world_height;

        // TODO: fix semi-nasty vars
        SWEARS.things = {};
        SWEARS.moves = file.moves;
        SWEARS.index = 0;

        // start Swears with appropriate values
        SWEARS.framerate = 100;
        SWEARS.play(SWEARS.framerate, document.getElementById('target'), width, height, call_me);
      });
    }
    
  </script> 
  
  
  <a href="" onclick="do_stuff(); return false;">Play</a>
  <a href="" onclick="SWEARS.pause(); return false;">Pause</a>
  
  <div id="winner" style="display:none"><strong>The winner is <span class="winner_name"></span>!!!</strong></div>
  
  <div><pre id="target"></pre></div> 
  
  <p>Player list:</p>
  <div id="health">
    
  </div>
  
</body> 
</html>